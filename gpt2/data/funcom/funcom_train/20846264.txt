TDAT: private int upgrade ( int idx , node n ) {  <NL> int last granted = last granted ( ) ;  <NL>  <NL> n . state = node . writer ;  <NL>  <NL>  / / at this point there cannot be another granted writer <NL> first writer = last granted ;  <NL>  <NL>  / / do this only if we are not the one and only within the queue <NL> if ( last granted > 0 ) {  <NL> waiters . remove element at ( idx ) ;  <NL> waiters . insert element at ( n , last granted ) ;  <NL>  <NL> n . granted = false ;  <NL> return last granted ;  <NL>  }  <NL> return idx ;  <NL>  }  COM: <s> upgrade node of thread at position idx to a writer </s>